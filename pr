CREATE PROCEDURE [dbo].[usp_Customer_UpdateCustomerGroupId]
    @LastUpsertDateTime DATETIME
AS
BEGIN
    SET NOCOUNT ON;

    -- Begin transaction early
    BEGIN TRANSACTION;

    -- CTE for latest Customer and ConsumerGroup changes
    WITH ChangedGroupIds AS (
        SELECT
            C.CustomerId,
            C.CustomerGroupId
        FROM dbo.Customer C
        WHERE C.UpsertDateTime >= @LastUpsertDateTime

        UNION

        SELECT
            CG.ConsumerID AS CustomerId,
            CG.GroupID AS CustomerGroupId
        FROM dbo.ConsumerGroup CG
        WHERE CG.DateModified >= @LastUpsertDateTime
    ),
    -- Join to ConsumerGroup to get latest group IDs
    MatchedUpdates AS (
        SELECT
            C.CustomerId,
            CG.GroupID AS NewGroupId
        FROM ChangedGroupIds C
        INNER JOIN dbo.ConsumerGroup CG
            ON C.CustomerId = CG.ConsumerID
        INNER JOIN dbo.Customer Cust
            ON C.CustomerId = Cust.CustomerId
        WHERE ISNULL(C.CustomerGroupId, '00000000-0000-0000-0000-000000000000') 
              <> ISNULL(CG.GroupID, '00000000-0000-0000-0000-000000000000')
    )
    
    -- Perform update
    UPDATE C
    SET C.CustomerGroupId = MU.NewGroupId
    FROM dbo.Customer C
    INNER JOIN MatchedUpdates MU
        ON C.CustomerId = MU.CustomerId;

    COMMIT TRANSACTION;
END;
