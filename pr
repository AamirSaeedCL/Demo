DECLARE @CDC_OP_INSERT INT = 2;
DECLARE @CDC_OP_UPDATE_AFTER INT = 4;
DECLARE @LastRunDateTime DATETIME2 = TRY_CAST('@{activity('Lookup the pipeline log table to fetch lastrundatetime').output.value[0].LastRunDateTime}' AS DATETIME2);

DECLARE @LastRunDateTimeCorrected DATETIME2 = CAST(@LastRunDateTime AT TIME ZONE 'UTC' AT TIME ZONE 'GMT Standard Time' AS DATETIME);
DECLARE @from_lsn AS BINARY(10) = [sys].[fn_cdc_map_time_to_lsn]('smallest greater than or equal', @LastRunDateTimeCorrected);
DECLARE @to_lsn AS BINARY(10) = [sys].[fn_cdc_get_max_lsn]();
DECLARE @min_valid_lsn BINARY(10) = [sys].[fn_cdc_get_min_lsn]('dbo_cnsmr');

-- If datetime based lsn is less than the minimum valid lsn then use minimum valid lsn
-- This is done to prevent error where changes to the CDC table reset the minimum valid lsn
IF @from_lsn < @min_valid_lsn OR @from_lsn is NULL
    SET @from_lsn = @min_valid_lsn;
