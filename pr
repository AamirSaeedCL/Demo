WITH TagData AS (
    SELECT
        c.cnsmr_id,
        c.cnsmr_idntfr_lgcy_txt,
        t.tag_typ_id,
        t.tag_shrt_nm,
        ct.cnsmr_tag_assgn_dt,
        CASE WHEN ct.cnsmr_tag_sft_delete_flg = 'Y' THEN ct.upsrt_dttm END AS tag_removed_dt,
        CASE WHEN ct.cnsmr_tag_sft_delete_flg = 'Y' THEN 0 ELSE 1 END AS tag_active
    FROM cnsmr c
    LEFT JOIN cnsmr_tag ct
        ON ct.cnsmr_id = c.cnsmr_id
    LEFT JOIN tag t
        ON t.tag_id = ct.tag_id
    WHERE t.tag_typ_id IN (
        '[DD_TAG]', '[DIAL_TAG]', '[DIGITAL_TAG]', '[PAYPHASE]', '[PHASE_TAG]', 
        '[PLAN_TAG]', '[PRE_DEF_TAG]', '[STATUS_TAG]'
    )
)
SELECT
    td.cnsmr_id               AS CustomerID,
    td.cnsmr_idntfr_lgcy_txt  AS LegacyID,

    MAX(CASE WHEN tag_typ_id = '[DD_TAG]' THEN tag_shrt_nm END)               AS DDTag,
    MAX(CASE WHEN tag_typ_id = '[DD_TAG]' THEN cnsmr_tag_assgn_dt END)        AS DateDDTagAssigned,
    MAX(CASE WHEN tag_typ_id = '[DD_TAG]' THEN tag_removed_dt END)            AS DateDDTagRemoved,
    MAX(CASE WHEN tag_typ_id = '[DD_TAG]' THEN tag_active END)                AS DDTagActive,

    MAX(CASE WHEN tag_typ_id = '[DIAL_TAG]' THEN tag_shrt_nm END)             AS DialTag,
    MAX(CASE WHEN tag_typ_id = '[DIAL_TAG]' THEN cnsmr_tag_assgn_dt END)      AS DateDialAssigned,
    MAX(CASE WHEN tag_typ_id = '[DIAL_TAG]' THEN tag_removed_dt END)          AS DateDialRemoved,
    MAX(CASE WHEN tag_typ_id = '[DIAL_TAG]' THEN tag_active END)              AS DialActive,

    MAX(CASE WHEN tag_typ_id = '[DIGITAL_TAG]' THEN tag_shrt_nm END)          AS DigitalTag,
    MAX(CASE WHEN tag_typ_id = '[DIGITAL_TAG]' THEN cnsmr_tag_assgn_dt END)   AS DateDigitalAssigned,
    MAX(CASE WHEN tag_typ_id = '[DIGITAL_TAG]' THEN tag_removed_dt END)       AS DateDigitalRemoved,
    MAX(CASE WHEN tag_typ_id = '[DIGITAL_TAG]' THEN tag_active END)           AS DigitalActive,

    MAX(CASE WHEN tag_typ_id = '[PAYPHASE]' THEN tag_shrt_nm END)             AS PayerPhaseTag,
    MAX(CASE WHEN tag_typ_id = '[PAYPHASE]' THEN cnsmr_tag_assgn_dt END)      AS DatePayerPhaseAssigned,
    MAX(CASE WHEN tag_typ_id = '[PAYPHASE]' THEN tag_removed_dt END)          AS DatePayerPhaseRemoved,
    MAX(CASE WHEN tag_typ_id = '[PAYPHASE]' THEN tag_active END)              AS PayerPhaseActive,

    MAX(CASE WHEN tag_typ_id = '[PHASE_TAG]' THEN tag_shrt_nm END)            AS PhaseTag,
    MAX(CASE WHEN tag_typ_id = '[PHASE_TAG]' THEN cnsmr_tag_assgn_dt END)     AS DatePhaseAssigned,
    MAX(CASE WHEN tag_typ_id = '[PHASE_TAG]' THEN tag_removed_dt END)         AS DatePhaseRemoved,
    MAX(CASE WHEN tag_typ_id = '[PHASE_TAG]' THEN tag_active END)             AS PhaseActive,

    MAX(CASE WHEN tag_typ_id = '[PLAN_TAG]' THEN tag_shrt_nm END)             AS PlanTag,
    MAX(CASE WHEN tag_typ_id = '[PLAN_TAG]' THEN cnsmr_tag_assgn_dt END)      AS DatePlanAssigned,
    MAX(CASE WHEN tag_typ_id = '[PLAN_TAG]' THEN tag_removed_dt END)          AS DatePlanRemoved,
    MAX(CASE WHEN tag_typ_id = '[PLAN_TAG]' THEN tag_active END)              AS PlanActive,

    MAX(CASE WHEN tag_typ_id = '[PRE_DEF_TAG]' THEN tag_shrt_nm END)          AS PreDefTag,
    MAX(CASE WHEN tag_typ_id = '[PRE_DEF_TAG]' THEN cnsmr_tag_assgn_dt END)   AS DatePreDefAssigned,
    MAX(CASE WHEN tag_typ_id = '[PRE_DEF_TAG]' THEN tag_removed_dt END)       AS DatePreDefRemoved,
    MAX(CASE WHEN tag_typ_id = '[PRE_DEF_TAG]' THEN tag_active END)           AS PreDefActive,

    MAX(CASE WHEN tag_typ_id = '[STATUS_TAG]' THEN tag_shrt_nm END)           AS StatusTag,
    MAX(CASE WHEN tag_typ_id = '[STATUS_TAG]' THEN cnsmr_tag_assgn_dt END)    AS DateStatusAssigned,
    MAX(CASE WHEN tag_typ_id = '[STATUS_TAG]' THEN tag_removed_dt END)        AS DateStatusRemoved,
    MAX(CASE WHEN tag_typ_id = '[STATUS_TAG]' THEN tag_active END)            AS StatusActive

FROM TagData td
GROUP BY td.cnsmr_id, td.cnsmr_idntfr_lgcy_txt;
