SET NOCOUNT ON;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

-- Declare constants for hard-coded values
DECLARE @PaymentPlanStatusCompleted INT = 9;
DECLARE @BalanceName NVARCHAR(50) = 'CurrentBalance';
DECLARE @PlanBalanceThreshold DECIMAL(18,2) = 50;
DECLARE @JointAccountType INT = 2;

-- CTE for First Instalment
WITH FirstInstalment AS (
    SELECT
        schdld_pymnt_smmry_id,
        schdld_pymnt_instnc_amnt,
        schdld_pymnt_instnc_dttm
    FROM (
        SELECT 
            schdld_pymnt_smmry_id,
            schdld_pymnt_instnc_amnt,
            schdld_pymnt_instnc_dttm,
            ROW_NUMBER() OVER (
                PARTITION BY schdld_pymnt_smmry_id 
                ORDER BY schdld_pymnt_instnc_dttm ASC
            ) AS rn
        FROM [dbo].[schdld_pymnt_instnc] WITH (NOLOCK)
    ) AS ranked
    WHERE rn = 1
),
-- CTE for PaymentPlan reference values
PaymentPlan AS (
    SELECT DISTINCT
        f.pymnt_frqncy_cd,
        f.pymnt_frqncy_val_txt,
        s.schdld_pymnt_stts_cd,
        s.schdld_pymnt_stts_val_txt,
        t.schdld_pymnt_typ_cd,
        t.schdld_pymnt_typ_val_txt
    FROM dbo.Ref_pymnt_frqncy_cd f WITH (NOLOCK)
    CROSS JOIN dbo.Ref_schdld_pymnt_stts_cd s WITH (NOLOCK)
    CROSS JOIN dbo.Ref_schdld_pymnt_typ_cd t WITH (NOLOCK)
),
-- CTE for Plan End Date
PlanEndDate AS (
    SELECT 
        sps.cnsmr_id,
        DATEDIFF(DAY, CAST(GETDATE() AS DATE), CAST(sps.schdld_pymnt_smmry_end_dttm AS DATE)) AS DaysTillCurrentPlanEndDate,
        sps.schdld_pymnt_smmry_end_dttm AS PaymentPlanEndDate,
        sps.schdld_pymnt_smmry_id
    FROM crs5_oltp.dbo.schdld_pymnt_smmry sps WITH (NOLOCK)
    WHERE sps.schdld_pymnt_smmry_stts_cd = @PaymentPlanStatusCompleted
),
-- CTE for Filtered Customers (Payment Plan Type)
FilteredCustomers AS (
    SELECT sps.cnsmr_id, rpr.pymnt_rsn_val_txt AS PaymentPlanType
    FROM crs5_oltp.dbo.schdld_pymnt_smmry sps WITH (NOLOCK)
    LEFT JOIN crs5_oltp.dbo.ref_pymnt_rsn_cd rpr WITH (NOLOCK)
        ON sps.schdld_pymnt_rsn_cd = rpr.pymnt_rsn_cd
    WHERE sps.schdld_pymnt_smmry_stts_cd = @PaymentPlanStatusCompleted
),
-- CTE for Active Plan Instalments
ActivePlanInstData AS (
    SELECT sps.cnsmr_id,
           oi.SUM_OF_OUTSTANDING_INSTALMENTS
    FROM crs5_oltp.dbo.schdld_pymnt_smmry sps WITH (NOLOCK)
    INNER JOIN (
        SELECT schdld_pymnt_smmry_id,
               SUM(schdld_pymnt_instnc_unpaid_bal_amnt) AS SUM_OF_OUTSTANDING_INSTALMENTS
        FROM crs5_oltp.dbo.schdld_pymnt_instnc WITH (NOLOCK)
        WHERE schdld_pymnt_instnc_unpaid_bal_amnt > 0
        GROUP BY schdld_pymnt_smmry_id
    ) oi
    ON sps.schdld_pymnt_smmry_id = oi.schdld_pymnt_smmry_id
    WHERE sps.schdld_pymnt_smmry_stts_cd = @PaymentPlanStatusCompleted
      AND oi.SUM_OF_OUTSTANDING_INSTALMENTS IS NOT NULL
),
-- CTE for Current Balance
CurrentBalance AS (
    SELECT cao.cnsmr_id,
           SUM(cab.cnsmr_accnt_bal_amnt) AS currentBalance
    FROM crs5_oltp.dbo.cnsmr_accnt_ownrs cao WITH (NOLOCK)
    INNER JOIN crs5_oltp.dbo.cnsmr_accnt_bal cab WITH (NOLOCK)
        ON cao.cnsmr_accnt_id = cab.cnsmr_accnt_id
       AND cao.cnsmr_accnt_ownrshp_sft_dlt_flg = 'N'
       AND cab.bal_nm_id = (SELECT bal_nm_id FROM crs5_oltp.dbo.bal_nm WITH (NOLOCK) WHERE bal_nm = @BalanceName)
    GROUP BY cao.cnsmr_id
    HAVING SUM(cab.cnsmr_accnt_bal_amnt) > 0
),
-- CTE for Plan Balance Remaining
PlanBalanceRemaining AS (
    SELECT ap.cnsmr_id,
           CASE WHEN (ap.SUM_OF_OUTSTANDING_INSTALMENTS <= (cb.currentBalance - @PlanBalanceThreshold)) THEN 1 ELSE 0 END AS PlanBalanceRemaining
    FROM ActivePlanInstData ap
    INNER JOIN CurrentBalance cb
        ON ap.cnsmr_id = cb.cnsmr_id
),
-- CTE for Days Since Plan Creation
DaysSincePlanCreation AS (
    SELECT sps.cnsmr_id,
           DATEDIFF(DAY, CAST(sps.schdld_pymnt_smmry_crt_dttm AS DATE), CAST(GETDATE() AS DATE)) AS DaysSincePlanCreationDate,
           sps.schdld_pymnt_smmry_crt_dttm AS PaymentPlanCreationDate
    FROM crs5_oltp.dbo.schdld_pymnt_smmry sps WITH (NOLOCK)
    WHERE sps.schdld_pymnt_smmry_stts_cd = @PaymentPlanStatusCompleted
),
-- CTE for Joint Accounts & Other Customer Plan Status
JointAccounts AS (
    SELECT cao.cnsmr_accnt_id, cao.cnsmr_id
    FROM crs5_oltp.dbo.cnsmr_accnt_ownrs cao WITH (NOLOCK)
    WHERE cnsmr_accnt_ownrshp_typ_cd = @JointAccountType
),
JointAccountsWithPlan AS (
    SELECT ja.cnsmr_accnt_id, ja.cnsmr_id, 
           CASE WHEN sps.schdld_pymnt_smmry_stts_cd = @PaymentPlanStatusCompleted THEN 'ACTIVE' ELSE 'NONE' END AS PlanStatus
    FROM JointAccounts ja
    LEFT JOIN crs5_oltp.dbo.schdld_pymnt_smmry sps WITH (NOLOCK)
        ON ja.cnsmr_id = sps.cnsmr_id
),
OtherJointCustomerPlan AS (
    SELECT ja1.cnsmr_id, ja2.PlanStatus AS JointAccountCustomerPlanStatus
    FROM JointAccountsWithPlan ja1
    INNER JOIN JointAccountsWithPlan ja2
        ON ja1.cnsmr_accnt_id = ja2.cnsmr_accnt_id
    WHERE ja1.cnsmr_id <> ja2.cnsmr_id
),
-- CTE for UDEF Payment Plan Letter Vars
UDEFPaymentPlan AS (
    SELECT cnsmr_id, UDEFPLAN_TYPE AS PlanTypeDescription
    FROM crs5_oltp.dbo.UDEFPAYMENT_PLAN_LETTER_VARS WITH (NOLOCK)
    WHERE UDEFPLAN_TYPE IS NOT NULL
),
-- CTE for Latest Scheduled Payment Status (Query 2)
LatestPaymentStatus AS (
    SELECT sps.cnsmr_id, sps.schdld_pymnt_stts_val_txt AS ScheduledPaymentStatus
    FROM (
        SELECT ROW_NUMBER() OVER (PARTITION BY sps.cnsmr_id ORDER BY sps.schdld_pymnt_smmry_crt_dttm DESC) AS RowNumber,
               sps.cnsmr_id, sc.schdld_pymnt_stts_val_txt
        FROM crs5_oltp.dbo.schdld_pymnt_smmry sps WITH (NOLOCK)
        INNER JOIN crs5_oltp.dbo.Ref_schdld_pymnt_stts_cd sc WITH (NOLOCK)
            ON sps.schdld_pymnt_smmry_stts_cd = sc.schdld_pymnt_stts_cd
    ) AS sps
    WHERE sps.RowNumber = 1
)

-- Final Combined SELECT
SELECT DISTINCT
    summary.schdld_pymnt_smmry_id AS PaymentPlanId,
    summary.cnsmr_id AS CustomerId,
    CAST(NULL AS uniqueidentifier) AS CustomerGroupId,
    summary.schdld_pymnt_smmry_ttl_amnt AS PlanAmount,
    summary.schdld_pymnt_smmry_cmmnt_txt AS PlanComment,
    summary.schdld_pymnt_smmry_cnt AS InstalmentCount,
    summary.schdld_pymnt_smmry_dwnpymnt_amnt AS InitialPaymentAmount,
    summary.schdld_pymnt_smmry_dwnpymnt_dttm AS InitialPaymentDate,
    summary.schdld_pymnt_smmry_rglr_amnt AS RegularPaymentAmount,
    fi.schdld_pymnt_instnc_amnt AS FirstInstalmentAmount,
    fi.schdld_pymnt_instnc_dttm AS FirstInstalmentDate,
    summary.schdld_pymnt_smmry_lst_amnt AS LastInstalmentAmount,
    CAST(CASE WHEN settlement.cnsmr_accnt_sttlmnt_id IS NOT NULL THEN 1 ELSE 0 END AS BIT) AS IsSettlement,
    summary.schdld_pymnt_smmry_frqncy_cd AS PlanFrequencyId,
    ref.pymnt_frqncy_val_txt AS PlanFrequencyText,
    summary.schdld_pymnt_smmry_frqncy_cnt AS PlanFrequencyCount,
    summary.schdld_pymnt_smmry_typ_cd AS PlanTypeId,
    ref.schdld_pymnt_typ_val_txt AS PlanTypeText,
    summary.schdld_pymnt_smmry_stts_cd AS PlanStatusId,
    ref.schdld_pymnt_stts_val_txt AS PlanStatusText,
    CAST(CASE WHEN ref.schdld_pymnt_stts_val_txt IS NOT NULL THEN 1 ELSE 0 END AS BIT) AS PlanStatusActive,
    summary.schdld_pymnt_smmry_crt_dttm AS CreatedDate,
    summary.upsrt_dttm AS UpsertDateTime,
    ped.DaysTillCurrentPlanEndDate,
    ped.PaymentPlanEndDate,
    fc.PaymentPlanType,
    pbr.PlanBalanceRemaining,
    dspc.DaysSincePlanCreationDate,
    dspc.PaymentPlanCreationDate,
    ojc.JointAccountCustomerPlanStatus,
    udef.PlanTypeDescription,
    lps.ScheduledPaymentStatus
FROM [dbo].[schdld_pymnt_smmry] summary WITH (NOLOCK)
LEFT JOIN FilteredCustomers fc
    ON fc.cnsmr_id = summary.cnsmr_id
LEFT JOIN FirstInstalment fi 
    ON fi.schdld_pymnt_smmry_id = summary.schdld_pymnt_smmry_id
LEFT JOIN [dbo].[cnsmr_accnt_sttlmnt] settlement WITH (NOLOCK)
    ON settlement.schdld_pymnt_smmry_id = summary.schdld_pymnt_smmry_id
JOIN PaymentPlan ref
    ON ref.pymnt_frqncy_cd = summary.schdld_pymnt_smmry_frqncy_cd
   AND ref.schdld_pymnt_stts_cd = summary.schdld_pymnt_smmry_stts_cd
   AND ref.schdld_pymnt_typ_cd = summary.schdld_pymnt_smmry_typ_cd
LEFT JOIN PlanEndDate ped
    ON ped.schdld_pymnt_smmry_id = summary.schdld_pymnt_smmry_id
LEFT JOIN PlanBalanceRemaining pbr
    ON pbr.cnsmr_id = summary.cnsmr_id
LEFT JOIN DaysSincePlanCreation dspc
    ON dspc.cnsmr_id = summary.cnsmr_id
LEFT JOIN OtherJointCustomerPlan ojc
    ON ojc.cnsmr_id = summary.cnsmr_id
LEFT JOIN UDEFPaymentPlan udef
    ON udef.cnsmr_id = summary.cnsmr_id
LEFT JOIN LatestPaymentStatus lps
    ON lps.cnsmr_id = summary.cnsmr_id
OPTION (RECOMPILE);

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
