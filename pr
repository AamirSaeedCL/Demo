SET NOCOUNT ON;

-- Declare and validate LastRunDateTime
DECLARE @LastRunDateTime DATETIME2 = TRY_CAST(
    '@{activity('Lookup the pipeline log table to fetch lastrundatetime').output.value[0].LastRunDateTime}' 
    AS DATETIME2
);

IF @LastRunDateTime IS NULL
BEGIN
    THROW 50001, 'Invalid LastRunDateTime Value', 1;
END;

-- Main query without using a temp table
SELECT 
    [DebtorNo]                     AS LegacyId,
    CAST(NULL AS UNIQUEIDENTIFIER) AS CustomerGroupId,
    [NDI]                          AS NetDisposableIncome,
    [LastRunDate]                  AS UpsertDateTime
FROM 
    [dbo].[DynamicMinimumPayment] WITH (NOLOCK)
WHERE 
    [LastRunDate] > @LastRunDateTime
ORDER BY 
    [LastRunDate] ASC
OPTION (RECOMPILE);

-- Restore default transaction isolation level (if previously altered)
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
