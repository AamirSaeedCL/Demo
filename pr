
SET NOCOUNT ON;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

-- CDC operation constants
DECLARE 
    @CDC_OP_INSERT INT = 2,
    @CDC_OP_UPDATE_AFTER INT = 4;

DECLARE 
    @LastRunDateTime DATETIME2 = '2025-01-01', --TRY_CAST('@{activity('Lookup the pipeline log table to fetch lastrundatetime').output.value[0].LastRunDateTime}' AS DATETIME2),
    @PaymentTypeCode INT = 2,
    @PaymentReversalTypeCode INT = 9,
    @ExcludedWorkgroupShortNames VARCHAR(50) = 'ZZZ,SDR,ZSB',
    @WorkgroupIdChangePattern NVARCHAR(50) = 'U:%wrkgrp_id',
    @CurrentBalanceShortName NVARCHAR(50) = 'CurBal',
    @HistoryMonthsBack INT = 3,
    @PaymentTndrd INT = 30;

-- Validate input
IF @LastRunDateTime IS NULL
BEGIN
    THROW 50001, 'Invalid LastRunDateTime Value', 1;
END;

-- Workgroups to exclude
WITH WorkgroupIDs AS (
    SELECT wrkgrp_id
    FROM [dbo].[wrkgrp]
    WHERE wrkgrp_shrt_nm IN (SELECT value FROM STRING_SPLIT(@ExcludedWorkgroupShortNames, ','))
),

-- Consumers with recent workgroup change
RecentWorkgroupChanges AS (
    SELECT DISTINCT cnsmr_id
    FROM [dbo].[cnsmr_hst]
    WHERE upsrt_chng_fld_txt LIKE @WorkgroupIdChangePattern
      AND adt_dttm >= DATEADD(MONTH, -@HistoryMonthsBack, GETDATE())
),

-- Consumers with payments in last @PaymentTndrd days
RecentPaymentChanges AS (
    SELECT DISTINCT cpj.cnsmr_id
    FROM [dbo].[cnsmr_pymnt_jrnl] cpj
    WHERE cpj.cnsmr_pymnt_tndrd_dt >= DATEADD(DAY, -@PaymentTndrd, GETDATE())
),

-- Consumers with negative balance
ConsumersWithZeroBalance AS (
    SELECT DISTINCT c.cnsmr_id
    FROM [dbo].[cnsmr] c
    INNER JOIN [dbo].[cnsmr_accnt_ownrs] cao ON cao.cnsmr_id = c.cnsmr_id
    INNER JOIN [dbo].[cnsmr_accnt] ca ON ca.cnsmr_accnt_id = cao.cnsmr_accnt_id
    INNER JOIN [dbo].[cnsmr_accnt_bal] cab ON cab.cnsmr_accnt_id = ca.cnsmr_accnt_id
    INNER JOIN [dbo].[bal_nm] bn ON bn.bal_nm_id = cab.bal_nm_id
    WHERE bn.bal_shrt_nm = @CurrentBalanceShortName
      AND cab.cnsmr_accnt_bal_amnt < 0
)

-- Final result
SELECT
    capj.cnsmr_accnt_pymnt_jrnl_id AS AccountPaymentId,
    capj.cnsmr_accnt_id            AS AccountId,
    rbtc.bckt_trnsctn_typ_cd       AS PaymentTypeId,
    rbtc.bckt_trnsctn_val_txt      AS PaymentTypeText,
    capj.cnsmr_accnt_pymnt_amnt    AS PaymentAmount,
    ISNULL(capj.cnsmr_accnt_pymnt_bal_amnt, 0) AS BalanceAmount,
    capj.cnsmr_accnt_pymnt_cmmnt_txt AS PaymentComment,
    capj.cnsmr_accnt_pymnt_stts_cd AS PaymentStatusId,
    rps.pymnt_stts_dscrptn_txt     AS PaymentStatusText,
    CAST(NULL AS DATETIME2)        AS PaymentStatusDate,
    capj.cnsmr_accnt_pymnt_pstd_dt AS PostedDate,
    capj.cnsmr_pymnt_entrd_dt      AS EnteredDate,
    capj.upsrt_dttm                AS UpsertDateTime
FROM (
    SELECT 
        capj.*,
        c.cnsmr_id,
        ROW_NUMBER() OVER (
            PARTITION BY c.cnsmr_id 
            ORDER BY capj.__$start_lsn DESC, capj.__$seqval DESC
        ) AS RowNumber
    FROM [cdc].[dbo_cnsmr_accnt_pymnt_jrnl_CT] capj WITH (NOLOCK)
    INNER JOIN [crs5_oltp].[dbo].[cnsmr_accnt] ca WITH (NOLOCK) 
        ON ca.cnsmr_accnt_id = capj.cnsmr_accnt_id
    INNER JOIN [dbo].[cnsmr] c WITH (NOLOCK) 
        ON ca.cnsmr_id = c.cnsmr_id
    INNER JOIN [crs5_oltp].[dbo].[Ref_bckt_trnsctn_typ_cd] rbtc WITH (NOLOCK)
        ON capj.bckt_trnsctn_typ_cd = rbtc.bckt_trnsctn_typ_cd
    INNER JOIN [crs5_oltp].[dbo].[Ref_pymnt_stts_cd] rps WITH (NOLOCK)
        ON capj.cnsmr_accnt_pymnt_stts_cd = rps.pymnt_stts_cd
    WHERE 
        capj.upsrt_dttm > @LastRunDateTime
        AND capj.__$operation IN (@CDC_OP_INSERT, @CDC_OP_UPDATE_AFTER)
        AND capj.bckt_trnsctn_typ_cd IN (@PaymentTypeCode, @PaymentReversalTypeCode)
        AND (
            -- Consumer NOT in excluded workgroups
            NOT EXISTS (
                SELECT 1 FROM WorkgroupIDs w 
                WHERE w.wrkgrp_id = c.wrkgrp_id
            )
            OR
            -- Consumer in excluded workgroup but with recent change
            (EXISTS (
                SELECT 1 FROM WorkgroupIDs w 
                WHERE w.wrkgrp_id = c.wrkgrp_id
            ) AND EXISTS (
                SELECT 1 FROM RecentWorkgroupChanges rw 
                WHERE rw.cnsmr_id = c.cnsmr_id
            ))
            OR
            -- Consumer with recent payment
            EXISTS (
                SELECT 1 FROM RecentPaymentChanges rp 
                WHERE rp.cnsmr_id = c.cnsmr_id
            )
            OR
            -- Consumer with negative balance
            EXISTS (
                SELECT 1 FROM ConsumersWithZeroBalance zb 
                WHERE zb.cnsmr_id = c.cnsmr_id
            )
        )
) AS filtered
WHERE filtered.RowNumber = 1
ORDER BY filtered.upsrt_dttm;

-- Reset isolation level
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;




Error:

Msg 4104, Level 16, State 1, Line 756
The multi-part identifier "capj.cnsmr_accnt_pymnt_jrnl_id" could not be bound.
Msg 4104, Level 16, State 1, Line 757
The multi-part identifier "capj.cnsmr_accnt_id" could not be bound.
Msg 4104, Level 16, State 1, Line 758
The multi-part identifier "rbtc.bckt_trnsctn_typ_cd" could not be bound.
Msg 4104, Level 16, State 1, Line 759
The multi-part identifier "rbtc.bckt_trnsctn_val_txt" could not be bound.
Msg 4104, Level 16, State 1, Line 760
The multi-part identifier "capj.cnsmr_accnt_pymnt_amnt" could not be bound.
Msg 4104, Level 16, State 1, Line 761
The multi-part identifier "capj.cnsmr_accnt_pymnt_bal_amnt" could not be bound.
Msg 4104, Level 16, State 1, Line 762
The multi-part identifier "capj.cnsmr_accnt_pymnt_cmmnt_txt" could not be bound.
Msg 4104, Level 16, State 1, Line 763
The multi-part identifier "capj.cnsmr_accnt_pymnt_stts_cd" could not be bound.
Msg 4104, Level 16, State 1, Line 764
The multi-part identifier "rps.pymnt_stts_dscrptn_txt" could not be bound.
Msg 4104, Level 16, State 1, Line 766
The multi-part identifier "capj.cnsmr_accnt_pymnt_pstd_dt" could not be bound.
Msg 4104, Level 16, State 1, Line 767
The multi-part identifier "capj.cnsmr_pymnt_entrd_dt" could not be bound.
Msg 4104, Level 16, State 1, Line 768
The multi-part identifier "capj.upsrt_dttm" could not be bound.
