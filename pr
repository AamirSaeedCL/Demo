CREATE PROCEDURE [dbo].[usp_UpsertDataFactoryPipeline]
    @PipelineName NVARCHAR(500),
    @IsAlreadyRunning BIT,
    @LastRunDateTime DATETIME2(7),
    @PipelineId SMALLINT OUTPUT
AS
BEGIN
    SET NOCOUNT ON;
    BEGIN TRY
        BEGIN TRANSACTION;

        -- Check if the pipeline already exists
        IF EXISTS (SELECT 1 FROM [dbo].[DataFactoryPipeline] WHERE [PipelineName] = @PipelineName)
        BEGIN
            -- Update the existing pipeline record
            UPDATE [dbo].[DataFactoryPipeline]
            SET 
                [IsAlreadyRunning] = @IsAlreadyRunning,
                [LastRunDateTime] = @LastRunDateTime
            WHERE 
                [PipelineName] = @PipelineName;

            -- Set output PipelineId
            SELECT @PipelineId = [PipelineId] 
            FROM [dbo].[DataFactoryPipeline] 
            WHERE [PipelineName] = @PipelineName;
        END
        ELSE
        BEGIN
            -- Insert new pipeline record
            INSERT INTO [dbo].[DataFactoryPipeline] ([PipelineName], [IsAlreadyRunning], [LastRunDateTime])
            VALUES (@PipelineName, @IsAlreadyRunning, @LastRunDateTime);

            -- Set the PipelineId to the new inserted value
            SET @PipelineId = SCOPE_IDENTITY();
        END

        COMMIT TRANSACTION;
    END TRY
    BEGIN CATCH
        -- Rollback the transaction if any error occurs
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION;

        -- Throw the error back to the caller
        THROW;
    END CATCH
END
GO
