-- Set isolation level to avoid locking during CDC reads
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

-- Define CDC operation constants
DECLARE @CDC_OP_INSERT INT = 2;
DECLARE @CDC_OP_UPDATE_AFTER INT = 4;

-- Define last run datetime (this could be dynamic in production)
DECLARE @LastRunDateTime DATETIME2 = '2025-01-01';

-- CTE to get the latest customer phone per CustomerId
WITH RecentCustomerPhones AS (
    SELECT
        cp.cnsmr_phn_id        AS CustomerPhoneId,
        cp.cnsmr_id            AS CustomerId,
        cp.cnsmr_phn_nmbr_txt  AS PhoneNumber,
        cp.cnsmr_phn_typ_cd    AS PhoneTypeCode,
        cp.cnsmr_phn_src_cd    AS PhoneSourceCode,
        cp.cnsmr_phn_stts_cd   AS PhoneStatusCode,
        cp.cnsmr_phn_cnsnt_dt  AS PhoneConsentDate,
        cp.upsrt_dttm          AS UpsertDateTime,
        CAST(CASE 
                WHEN cp.cnsmr_phn_sft_dlt_flg = 'Y' THEN 0 
                ELSE 1 
             END AS BIT)       AS PhoneActive,
        ROW_NUMBER() OVER (
            PARTITION BY cp.cnsmr_id 
            ORDER BY cp.__$start_lsn DESC, cp.__$seqval DESC
        ) AS RowNumber
    FROM 
        [crs5_oltp].[cdc].[dbo_cnsmr_Phn_CT] cp WITH (NOLOCK)
    WHERE 
        cp.cnsmr_phn_nmbr_txt IS NOT NULL
        AND cp.upsrt_dttm > @LastRunDateTime
        AND cp.__$operation IN (@CDC_OP_INSERT, @CDC_OP_UPDATE_AFTER)
)

-- Final query to join reference tables and return enriched data
SELECT
    rcp.CustomerPhoneId,
    rcp.CustomerId,
    CAST(NULL AS UNIQUEIDENTIFIER) AS CustomerGroupId,
    rcp.PhoneNumber,
    pt.phn_typ_val_txt   AS PhoneType,
    ps.phn_src_val_txt   AS PhoneSource,
    pst.phn_stts_val_txt AS PhoneStatus,
    rcp.PhoneConsentDate,
    rcp.PhoneActive,
    rcp.UpsertDateTime
FROM 
    RecentCustomerPhones rcp
    INNER JOIN Ref_phn_typ_cd   pt WITH (NOLOCK) ON rcp.PhoneTypeCode   = pt.phn_typ_cd
    INNER JOIN Ref_phn_src_cd   ps WITH (NOLOCK) ON rcp.PhoneSourceCode = ps.phn_src_cd
    INNER JOIN Ref_phn_stts_cd pst WITH (NOLOCK) ON rcp.PhoneStatusCode = pst.phn_stts_cd
WHERE 
    rcp.RowNumber = 1
ORDER BY 
    rcp.UpsertDateTime,
    rcp.CustomerPhoneId;

-- Reset isolation level
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
