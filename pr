
CREATE PROCEDURE [dbo].[usp_CustomerAccount_UpdateCustomerGroupId]
    @LastUpsertDateTime DATETIME
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION;
        
        UPDATE ca
        SET ca.customergroupid = c.customergroupid
        FROM dbo.CustomerAccount ca
        INNER JOIN dbo.Customer c WITH (NOLOCK) 
            ON ca.customerid = c.customerid
        WHERE ca.UpsertDateTime >= @LastUpsertDateTime

        COMMIT TRANSACTION;
    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END;


===========

Address:

CREATE PROCEDURE [dbo].[usp_CustomerAddress_UpdateCustomerGroupId]
    @LastUpsertDateTime DATETIME
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRY
        BEGIN TRANSACTION;
        
        UPDATE ca
        SET ca.customergroupid = c.customergroupid
        FROM dbo.CustomerAddress ca
        INNER JOIN dbo.Customer c WITH (NOLOCK) 
            ON ca.customerid = c.customerid
        WHERE ca.UpsertDateTime >= @LastUpsertDateTime

        COMMIT TRANSACTION;
    END TRY

    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END;


=================
Phone
CREATE PROCEDURE [dbo].[usp_CustomerPhone_UpdateCustomerGroupId]
    @LastUpsertDateTime DATETIME
AS
BEGIN
    SET NOCOUNT ON;
    
    BEGIN TRY
        BEGIN TRANSACTION;

        UPDATE cp
        SET cp.customergroupid = c.customergroupid
        FROM dbo.CustomerPhone cp
        INNER JOIN dbo.Customer c WITH (NOLOCK) 
            ON cp.customerid = c.customerid
        WHERE cp.UpsertDateTime >= @LastUpsertDateTime

        COMMIT TRANSACTION;
    END TRY

    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END;

=================
Tag:
CREATE PROCEDURE [dbo].[usp_CustomerTag_UpdateCustomerGroupId]
    @LastUpsertDateTime DATETIME
AS
BEGIN
    SET NOCOUNT ON;
        
    BEGIN TRY
        BEGIN TRANSACTION;

        UPDATE ct
        SET ct.customergroupid = c.customergroupid
        FROM dbo.CustomerTag ct
        INNER JOIN dbo.Customer c WITH (NOLOCK) 
            ON ct.customerid = c.customerid
        WHERE ct.UpsertDateTime >= @LastUpsertDateTime

        COMMIT TRANSACTION;
    END TRY

    BEGIN CATCH
        ROLLBACK TRANSACTION;
        THROW;
    END CATCH
END;
