ALTER PROCEDURE [dbo].[usp_DataFactoryPipelineLog_GetLastRunDateTime]
    @PipelineId INT  -- Input parameter for PipelineId
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @DefaultDate DATETIME2 = '1900-01-01';
    DECLARE @LastExecutionDateTime DATETIME2 = NULL;

    -- Retrieve the most recent successful pipeline run
    SELECT TOP (1)
        @LastExecutionDateTime = StartDateTime
    FROM
        dbo.DataFactoryPipelineLog WITH (NOLOCK)  -- Use NOLOCK with caution; may read uncommitted data
    WHERE
        PipelineId = @PipelineId
        AND ErrorDescription IS NULL
        AND EndDateTime IS NOT NULL
    ORDER BY
        LogId DESC;

    -- Return the last run date
    SELECT 
        ISNULL(@LastExecutionDateTime, @DefaultDate) AS LastRunDateTime;
END;
GO
