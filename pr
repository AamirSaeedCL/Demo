
CREATE PROCEDURE GetLastRunDateTime
    @PipelineId NVARCHAR(50)  -- Input parameter for PipelineId
AS
BEGIN
    -- Declare the default date variable
    DECLARE @DefaultDate DATETIME = '1900-01-01';

    BEGIN TRY
        -- Check for the existence of rows and return LastRunDateTime or default date
        IF EXISTS (
            SELECT 1
            FROM [dbo].[DataFactoryPipelineLog]
            WHERE PipelineId = @PipelineId
              AND ErrorDescription IS NULL
        )
        BEGIN
            SELECT TOP 1 
                [StartDateTime] AS LastRunDateTime
            FROM
                [dbo].[DataFactoryPipelineLog]
            WHERE
                PipelineId = @PipelineId
                AND ErrorDescription IS NULL
            ORDER BY
                LogId DESC;  -- Order by descending to get the most recent log
        END
        ELSE
        BEGIN
            -- Return default date if no rows are found
            SELECT @DefaultDate AS LastRunDateTime;
        END
    END TRY
    BEGIN CATCH
        -- Return default date in case of an error
        SELECT @DefaultDate AS LastRunDateTime;  -- Return the default date if an error occurs
    END CATCH;
END;
