SET NOCOUNT ON;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

-- Declare constants
DECLARE @PaymentPlanStatusCompleted INT = 9;
DECLARE @BalanceName NVARCHAR(50) = 'CurrentBalance';
DECLARE @PlanBalanceThreshold DECIMAL(18,2) = 50;
DECLARE @JointAccountType INT = 2;

-- CTEs for Query 2 logic (Joint Accounts & Latest JAOPAY/Active Plan)
WITH AllJointAccounts AS (
    SELECT DISTINCT cnsmr_accnt_id
    FROM cnsmr_accnt_ownrs WITH (NOLOCK)
    WHERE cnsmr_accnt_ownrshp_typ_cd = @JointAccountType
),
PrimaryConsumers AS (
    SELECT DISTINCT cao.cnsmr_id AS primary_cnsmr_id, allja.cnsmr_accnt_id
    FROM AllJointAccounts AS allja
    INNER JOIN cnsmr_accnt_ownrs AS cao WITH (NOLOCK) 
        ON allja.cnsmr_accnt_id = cao.cnsmr_accnt_id
    INNER JOIN cnsmr_Wrk_actn AS cwa WITH (NOLOCK) ON cao.cnsmr_id = cwa.cnsmr_id
    INNER JOIN cnsmr AS c WITH (NOLOCK) ON cao.cnsmr_id = c.cnsmr_id
    WHERE cao.cnsmr_accnt_ownrshp_typ_cd = 1
),
SecondaryConsumers AS (
    SELECT ROW_NUMBER() OVER (PARTITION BY allja.cnsmr_accnt_id ORDER BY cao.cnsmr_id) AS RowNumber,
           cao.cnsmr_id AS secondary_cnsmr_id, allja.cnsmr_accnt_id
    FROM AllJointAccounts AS allja
    INNER JOIN cnsmr_accnt_ownrs AS cao WITH (NOLOCK) 
        ON allja.cnsmr_accnt_id = cao.cnsmr_accnt_id
    INNER JOIN cnsmr_Wrk_actn AS cwa WITH (NOLOCK) ON cao.cnsmr_id = cwa.cnsmr_id
    INNER JOIN cnsmr AS c WITH (NOLOCK) ON cao.cnsmr_id = c.cnsmr_id
    WHERE cao.cnsmr_accnt_ownrshp_typ_cd = 2
),
LatestJAOPAY AS (
    SELECT ar.cnsmr_id, ar.LastJAOPAY
    FROM (
        SELECT ROW_NUMBER() OVER (PARTITION BY cao.cnsmr_id ORDER BY caal.upsrt_dttm DESC) AS RowNumber,
               cao.cnsmr_id, caal.upsrt_dttm AS LastJAOPAY
        FROM AllJointAccounts AS allja
        INNER JOIN cnsmr_accnt_ownrs AS cao WITH (NOLOCK) ON allja.cnsmr_accnt_id = cao.cnsmr_accnt_id
        INNER JOIN cnsmr_accnt_ar_log AS caal WITH (NOLOCK) ON cao.cnsmr_id = caal.cnsmr_id
        INNER JOIN actn_Cd AS ac WITH (NOLOCK) ON caal.actn_cd = ac.actn_Cd AND ac.actn_cd_shrt_val_txt = 'JAO'
        INNER JOIN rslt_Cd AS rc WITH (NOLOCK) ON caal.rslt_Cd = rc.rslt_Cd AND rc.rslt_cd_shrt_val_txt = 'PAY'
    ) AS ar
    WHERE ar.RowNumber = 1
),
ActivePlans AS (
    SELECT sps.cnsmr_id, sps.schdld_pymnt_smmry_crt_dttm AS ActivePlanCreationDate
    FROM AllJointAccounts AS allja
    INNER JOIN cnsmr_accnt_ownrs AS cao WITH (NOLOCK) ON allja.cnsmr_accnt_id = cao.cnsmr_accnt_id
    INNER JOIN schdld_pymnt_smmry AS sps WITH (NOLOCK) 
        ON cao.cnsmr_id = sps.cnsmr_id AND sps.schdld_pymnt_smmry_stts_cd = @PaymentPlanStatusCompleted
),
-- Flatten accounts with primary + up to 4 secondaries
AllAccounts AS (
    SELECT p1.cnsmr_accnt_id,
           p1.primary_cnsmr_id AS Consumer_P1, lp1.LastJAOPAY AS LastJAOPAY_P1, ap1.ActivePlanCreationDate AS ActivePlanDate_P1,
           s1.secondary_cnsmr_id AS Consumer_S1, ls1.LastJAOPAY AS LastJAOPAY_S1, aps1.ActivePlanCreationDate AS ActivePlanDate_S1,
           s2.secondary_cnsmr_id AS Consumer_S2, ls2.LastJAOPAY AS LastJAOPAY_S2, aps2.ActivePlanCreationDate AS ActivePlanDate_S2,
           s3.secondary_cnsmr_id AS Consumer_S3, ls3.LastJAOPAY AS LastJAOPAY_S3, aps3.ActivePlanCreationDate AS ActivePlanDate_S3,
           s4.secondary_cnsmr_id AS Consumer_S4, ls4.LastJAOPAY AS LastJAOPAY_S4, aps4.ActivePlanCreationDate AS ActivePlanDate_S4
    FROM PrimaryConsumers AS p1
    LEFT JOIN SecondaryConsumers AS s1 ON p1.cnsmr_accnt_id = s1.cnsmr_accnt_id AND s1.RowNumber = 1
    LEFT JOIN SecondaryConsumers AS s2 ON p1.cnsmr_accnt_id = s2.cnsmr_accnt_id AND s2.RowNumber = 2
    LEFT JOIN SecondaryConsumers AS s3 ON p1.cnsmr_accnt_id = s3.cnsmr_accnt_id AND s3.RowNumber = 3
    LEFT JOIN SecondaryConsumers AS s4 ON p1.cnsmr_accnt_id = s4.cnsmr_accnt_id AND s4.RowNumber = 4
    LEFT JOIN LatestJAOPAY AS lp1 ON lp1.cnsmr_id = p1.primary_cnsmr_id
    LEFT JOIN LatestJAOPAY AS ls1 ON ls1.cnsmr_id = s1.secondary_cnsmr_id
    LEFT JOIN LatestJAOPAY AS ls2 ON ls2.cnsmr_id = s2.secondary_cnsmr_id
    LEFT JOIN LatestJAOPAY AS ls3 ON ls3.cnsmr_id = s3.secondary_cnsmr_id
    LEFT JOIN LatestJAOPAY AS ls4 ON ls4.cnsmr_id = s4.secondary_cnsmr_id
    LEFT JOIN ActivePlans AS ap1 ON ap1.cnsmr_id = p1.primary_cnsmr_id
    LEFT JOIN ActivePlans AS aps1 ON aps1.cnsmr_id = s1.secondary_cnsmr_id
    LEFT JOIN ActivePlans AS aps2 ON aps2.cnsmr_id = s2.secondary_cnsmr_id
    LEFT JOIN ActivePlans AS aps3 ON aps3.cnsmr_id = s3.secondary_cnsmr_id
    LEFT JOIN ActivePlans AS aps4 ON aps4.cnsmr_id = s4.secondary_cnsmr_id
),
-- Latest Date Comparison
LastDates AS (
    SELECT aa.*,
           CASE WHEN CAST(MAX(v) OVER () AS DATE) >= CAST(MAX(u) OVER () AS DATE) THEN 1 ELSE 0 END AS JAOPAYAfterPlan
    FROM AllAccounts AS aa
),
-- CTEs from Query 1
FirstInstalment AS (
    SELECT schdld_pymnt_smmry_id, schdld_pymnt_instnc_amnt, schdld_pymnt_instnc_dttm
    FROM (
        SELECT schdld_pymnt_smmry_id, schdld_pymnt_instnc_amnt, schdld_pymnt_instnc_dttm,
               ROW_NUMBER() OVER (PARTITION BY schdld_pymnt_smmry_id ORDER BY schdld_pymnt_instnc_dttm ASC) AS rn
        FROM schdld_pymnt_instnc WITH (NOLOCK)
    ) AS ranked
    WHERE rn = 1
),
PaymentPlan AS (
    SELECT DISTINCT f.pymnt_frqncy_cd, f.pymnt_frqncy_val_txt,
           s.schdld_pymnt_stts_cd, s.schdld_pymnt_stts_val_txt,
           t.schdld_pymnt_typ_cd, t.schdld_pymnt_typ_val_txt
    FROM Ref_pymnt_frqncy_cd f WITH (NOLOCK)
    CROSS JOIN Ref_schdld_pymnt_stts_cd s WITH (NOLOCK)
    CROSS JOIN Ref_schdld_pymnt_typ_cd t WITH (NOLOCK)
),
-- Filter Query1 by cnsmr_ids from AllAccounts
FilteredCustomers AS (
    SELECT sps.cnsmr_id, rpr.pymnt_rsn_val_txt AS PaymentPlanType
    FROM schdld_pymnt_smmry sps WITH (NOLOCK)
    LEFT JOIN ref_pymnt_rsn_cd rpr WITH (NOLOCK) ON sps.schdld_pymnt_rsn_cd = rpr.pymnt_rsn_cd
    WHERE sps.schdld_pymnt_smmry_stts_cd = @PaymentPlanStatusCompleted
      AND sps.cnsmr_id IN (SELECT Consumer_P1 FROM AllAccounts
                           UNION
                           SELECT Consumer_S1 FROM AllAccounts
                           UNION
                           SELECT Consumer_S2 FROM AllAccounts
                           UNION
                           SELECT Consumer_S3 FROM AllAccounts
                           UNION
                           SELECT Consumer_S4 FROM AllAccounts)
)

-- Final Combined SELECT
SELECT DISTINCT summary.schdld_pymnt_smmry_id AS PaymentPlanId,
                summary.cnsmr_id AS CustomerId,
                fc.PaymentPlanType
FROM schdld_pymnt_smmry summary WITH (NOLOCK)
LEFT JOIN FilteredCustomers fc ON fc.cnsmr_id = summary.cnsmr_id
OPTION (RECOMPILE);

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
