DECLARE @LastRunDateTime DATETIME2 = TRY_CAST('2025-01-01' AS DATETIME2);

-- Convert UTC to GMT Standard Time correctly
DECLARE @LastRunDateTimeLocal DATETIME2 =
    CAST(SWITCHOFFSET(@LastRunDateTime AT TIME ZONE 'UTC', DATENAME(TzOffset, SYSDATETIMEOFFSET() AT TIME ZONE 'GMT Standard Time')) AS DATETIME2);

WITH TagData AS (
    SELECT
        c.cnsmr_id,
        c.cnsmr_idntfr_lgcy_txt,
        t.tag_typ_id,
        UPPER(tt.tag_typ_shrt_nm) AS tag_typ_shrt_nm,
        ct.cnsmr_tag_assgn_dt,
        CASE WHEN ct.cnsmr_tag_sft_delete_flg = 'Y' THEN ct.upsrt_dttm END AS tag_removed_dt,
        CASE WHEN ct.cnsmr_tag_sft_delete_flg = 'Y' THEN 0 ELSE 1 END AS tag_active,
        ct.cnsmr_tag_sft_delete_flg,
        ct.upsrt_dttm  -- added to filter later
    FROM cnsmr c WITH (NOLOCK)
    LEFT JOIN cnsmr_tag ct WITH (NOLOCK)
        ON ct.cnsmr_id = c.cnsmr_id
    LEFT JOIN tag t WITH (NOLOCK)
        ON t.tag_id = ct.tag_id
    LEFT JOIN tag_typ tt WITH (NOLOCK)
        ON t.tag_typ_id = tt.tag_typ_id
    WHERE UPPER(tt.tag_typ_shrt_nm) IN (
         'DDRETCD', 'DIAL_TAG', 'DIGITAL', 'PAYPHASE', 'PHASE', 
         'PLANSTAT', 'RMDTN', 'PREDEF', 'SMS', 'PLATSTAT'
    )
),
PreviousStatusData AS (
    SELECT
        c.cnsmr_id,
        MAX(ct.upsrt_dttm) AS latest_removed_dt
    FROM cnsmr c WITH (NOLOCK)
    JOIN cnsmr_tag ct WITH (NOLOCK)
        ON ct.cnsmr_id = c.cnsmr_id
    JOIN tag t WITH (NOLOCK)
        ON t.tag_id = ct.tag_id
    JOIN tag_typ tt WITH (NOLOCK)
        ON t.tag_typ_id = tt.tag_typ_id
    WHERE UPPER(tt.tag_typ_shrt_nm) = 'PLATSTAT'
      AND ct.cnsmr_tag_sft_delete_flg = 'Y'
    GROUP BY c.cnsmr_id
)
SELECT
    td.cnsmr_id               AS CustomerID,
    td.cnsmr_idntfr_lgcy_txt  AS LegacyID,

    -- DD Tag
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'DDRETCD' THEN tag_typ_shrt_nm END)           AS DDTag,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'DDRETCD' THEN cnsmr_tag_assgn_dt END)        AS DateDDTagAssigned,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'DDRETCD' THEN tag_removed_dt END)            AS DateDDTagRemoved,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'DDRETCD' THEN tag_active END)                AS DDTagActive,

    -- Dial Tag
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'DIAL_TAG' THEN tag_typ_shrt_nm END)          AS DialTag,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'DIAL_TAG' THEN cnsmr_tag_assgn_dt END)       AS DateDialAssigned,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'DIAL_TAG' THEN tag_removed_dt END)           AS DateDialRemoved,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'DIAL_TAG' THEN tag_active END)               AS DialActive,

    -- Digital Tag
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'DIGITAL' THEN tag_typ_shrt_nm END)           AS DigitalTag,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'DIGITAL' THEN cnsmr_tag_assgn_dt END)        AS DateDigitalAssigned,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'DIGITAL' THEN tag_removed_dt END)            AS DateDigitalRemoved,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'DIGITAL' THEN tag_active END)                AS DigitalActive,

    -- Payer Phase Tag
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PAYPHASE' THEN tag_typ_shrt_nm END)          AS PayerPhaseTag,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PAYPHASE' THEN cnsmr_tag_assgn_dt END)       AS DatePayerPhaseAssigned,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PAYPHASE' THEN tag_removed_dt END)           AS DatePayerPhaseRemoved,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PAYPHASE' THEN tag_active END)               AS PayerPhaseActive,

    -- Phase Tag
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PHASE' THEN tag_typ_shrt_nm END)             AS PhaseTag,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PHASE' THEN cnsmr_tag_assgn_dt END)          AS DatePhaseAssigned,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PHASE' THEN tag_removed_dt END)              AS DatePhaseRemoved,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PHASE' THEN tag_active END)                  AS PhaseActive,

    -- Plan Tag
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PLANSTAT' THEN tag_typ_shrt_nm END)          AS PlanTag,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PLANSTAT' THEN cnsmr_tag_assgn_dt END)       AS DatePlanAssigned,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PLANSTAT' THEN tag_removed_dt END)           AS DatePlanRemoved,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PLANSTAT' THEN tag_active END)               AS PlanActive,

    -- PreDef Tag
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PREDEF' THEN tag_typ_shrt_nm END)            AS PreDefTag,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PREDEF' THEN cnsmr_tag_assgn_dt END)         AS DatePreDefAssigned,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PREDEF' THEN tag_removed_dt END)             AS DatePreDefRemoved,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PREDEF' THEN tag_active END)                 AS PreDefActive,

    -- Remediation Tag
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'RMDTN' THEN tag_typ_shrt_nm END)             AS RemediationTag,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'RMDTN' THEN cnsmr_tag_assgn_dt END)          AS DateRemediationAssigned,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'RMDTN' THEN tag_removed_dt END)              AS DateRemediationRemoved,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'RMDTN' THEN tag_active END)                  AS RemediationActive,

    -- SMS Tag
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'SMS' THEN tag_typ_shrt_nm END)               AS SMSTag,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'SMS' THEN cnsmr_tag_assgn_dt END)            AS DateSMSAssigned,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'SMS' THEN tag_removed_dt END)                AS DateSMSRemoved,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'SMS' THEN tag_active END)                    AS SMSActive,

    -- Current Status Tag (PlatStat)
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PLATSTAT' THEN tag_typ_shrt_nm END)          AS StatusTag,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PLATSTAT' THEN cnsmr_tag_assgn_dt END)       AS DateStatusAssigned,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PLATSTAT' THEN tag_removed_dt END)           AS DateStatusRemoved,
    MAX(CASE WHEN UPPER(tag_typ_shrt_nm) = 'PLATSTAT' THEN tag_active END)               AS StatusActive,

    -- Previous Status Tag (latest deleted PlatStat)
    MAX(CASE 
            WHEN UPPER(tag_typ_shrt_nm) = 'PLATSTAT' 
                 AND td.cnsmr_tag_sft_delete_flg = 'Y'
                 AND td.tag_removed_dt = ps.latest_removed_dt
            THEN tag_typ_shrt_nm
        END)                                                                             AS PreviousStatusTag,
    MAX(CASE 
            WHEN UPPER(tag_typ_shrt_nm) = 'PLATSTAT'
                 AND td.cnsmr_tag_sft_delete_flg = 'Y'
                 AND td.tag_removed_dt = ps.latest_removed_dt
            THEN cnsmr_tag_assgn_dt
        END)                                                                             AS DatePreviousStatusAssigned,
    MAX(CASE 
            WHEN UPPER(tag_typ_shrt_nm) = 'PLATSTAT'
                 AND td.cnsmr_tag_sft_delete_flg = 'Y'
                 AND td.tag_removed_dt = ps.latest_removed_dt
            THEN tag_removed_dt
        END)                                                                             AS DatePreviousStatusRemoved,
    MAX(CASE 
            WHEN UPPER(tag_typ_shrt_nm) = 'PLATSTAT'
                 AND td.cnsmr_tag_sft_delete_flg = 'Y'
                 AND td.tag_removed_dt = ps.latest_removed_dt
            THEN 0
        END)                                                                             AS PreviousStatusActive

FROM TagData td
LEFT JOIN PreviousStatusData ps
    ON td.cnsmr_id = ps.cnsmr_id
WHERE td.upsrt_dttm >= @LastRunDateTimeLocal
GROUP BY td.cnsmr_id, td.cnsmr_idntfr_lgcy_txt;
