-- =============================================
-- Get the most recent PreferenceType per Consumer
-- =============================================

-- Declare constants
DECLARE @PreferenceGroupCode VARCHAR(10) = '2';
DECLARE @EmailCode CHAR(1) = '1';
DECLARE @SmsCode   CHAR(1) = '2';
DECLARE @PhoneCode CHAR(1) = '3';

-- Use CTE with window function for performance
WITH RankedPreferences AS (
    SELECT 
        ConsumerID,
        PreferenceTypeCode,
        LastModifiedDateTime,
        ROW_NUMBER() OVER (
            PARTITION BY ConsumerID 
            ORDER BY LastModifiedDateTime DESC
        ) AS rn
    FROM [Nyx].[PC].[PCPreference]
    WHERE PreferenceGroupCode = @PreferenceGroupCode
)
SELECT
    ConsumerID,
    CASE 
        WHEN PreferenceTypeCode = @EmailCode THEN 'Email'
        WHEN PreferenceTypeCode = @SmsCode THEN 'SMS'
        WHEN PreferenceTypeCode = @PhoneCode THEN 'Phone'
        WHEN PreferenceTypeCode IS NULL OR LTRIM(RTRIM(PreferenceTypeCode)) = '' THEN NULL
    END AS PreferenceTypeName,
    LastModifiedDateTime
FROM RankedPreferences
WHERE rn = 1;
