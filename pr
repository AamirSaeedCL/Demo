SET NOCOUNT ON;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

-- Parse LastRunDateTime from pipeline parameter
DECLARE @LastRunDateTime DATETIME2 = TRY_CAST(
    '@{activity('Lookup the pipeline log table to fetch lastrundatetime').output.value[0].LastRunDateTime}' 
    AS DATETIME2
);

-- Validate the input parameter
IF @LastRunDateTime IS NULL
BEGIN
    THROW 50001, 'Invalid LastRunDateTime Value', 1;
END;

-- Query data with Run_Date greater than the last run datetime
SELECT 
    DebtorNo, 
    Run_Date,
    DRS_V1_Score
FROM gold_modeloutputs.financial_strength_model_archive WITH (NOLOCK)
WHERE Run_Date > @LastRunDateTime;

-- Reset isolation level
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
