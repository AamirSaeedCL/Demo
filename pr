CREATE PROCEDURE [dbo].[usp_SetChangeTrackingStatus]
    @TableName NVARCHAR(128),
    @Enable BIT
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SchemaName NVARCHAR(128) = 'dbo';
    DECLARE @FullTableName NVARCHAR(256) = QUOTENAME(@SchemaName) + '.' + QUOTENAME(@TableName);
    DECLARE @ObjectId INT = OBJECT_ID(@FullTableName);

    IF @ObjectId IS NULL
    BEGIN
        RAISERROR('Table [%s] does not exist in schema [%s].', 16, 1, @TableName, @SchemaName);
        RETURN;
    END

    IF @Enable = 1
    BEGIN
        -- Only enable if not already enabled
        IF NOT EXISTS (SELECT 1 FROM sys.change_tracking_tables WHERE object_id = @ObjectId)
        BEGIN
            DECLARE @EnableSQL NVARCHAR(MAX) =
                N'ALTER TABLE ' + @FullTableName + ' ENABLE CHANGE_TRACKING WITH (TRACK_COLUMNS_UPDATED = OFF);';
            EXEC sp_executesql @EnableSQL;
        END
        ELSE
        BEGIN
            PRINT 'Change tracking is already enabled for table: ' + @FullTableName;
        END
    END
    ELSE
    BEGIN
        -- Only disable if it's currently enabled
        IF EXISTS (SELECT 1 FROM sys.change_tracking_tables WHERE object_id = @ObjectId)
        BEGIN
            DECLARE @DisableSQL NVARCHAR(MAX) =
                N'ALTER TABLE ' + @FullTableName + ' DISABLE CHANGE_TRACKING;';
            EXEC sp_executesql @DisableSQL;
        END
        ELSE
        BEGIN
            PRINT 'Change tracking is already disabled for table: ' + @FullTableName;
        END
    END
END
GO
