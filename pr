WITH LatestRemovedTags AS (
    SELECT
        ct.cnsmr_id,
        t.tag_shrt_nm,
        tt.tag_typ_shrt_nm,
        ct.upsrt_dttm,
        ct.cnsmr_tag_assgn_dt,
        CASE
            WHEN ct.cnsmr_tag_sft_delete_flg = 'Y'
            THEN ct.upsrt_dttm
        END AS tag_removed_dt,
        CASE
            WHEN ct.cnsmr_tag_sft_delete_flg = 'Y'
            THEN CAST(0 AS bit)
            ELSE CAST(1 AS bit)
        END AS tag_active,
        ROW_NUMBER() OVER (
            PARTITION BY ct.cnsmr_id
            ORDER BY ct.upsrt_dttm DESC
        ) AS rn
    FROM dbo.cnsmr_tag ct
    JOIN dbo.tag t
        ON t.tag_id = ct.tag_id
    JOIN dbo.tag_typ tt
        ON tt.tag_typ_id = t.tag_typ_id
       AND tt.tag_typ_shrt_nm = 'PLATSTAT'
    WHERE ct.cnsmr_tag_sft_delete_flg = 'Y'
      AND ct.upsrt_dttm >=
        CAST(
            SWITCHOFFSET(
                TRY_CAST(
                    '@{activity('Lookup the pipeline log table to fetch lastrundatetime').output}'
                    AS DATETIME2
                ) AT TIME ZONE 'UTC',
                DATENAME(
                    TzOffset,
                    SYSDATETIMEOFFSET() AT TIME ZONE 'GMT Standard Time'
                )
            ) AS DATETIME2
        )
)

SELECT
    cnsmr_id           AS CustomerId,
    tag_shrt_nm        AS TagValue,
    cnsmr_tag_assgn_dt AS TagAssignedDate,
    tag_removed_dt     AS TagRemovedDate,
    tag_active         AS TagActive,
    upsrt_dttm         AS UpsertDateTime
FROM LatestRemovedTags
WHERE rn = 1
ORDER BY cnsmr_id, TagRemovedDate DESC;
