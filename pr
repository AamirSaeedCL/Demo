SELECT sps.cnsmr_id
	, oi.SUM_OF_OUTSTANDING_INSTALMENTS
INTO #ActivePlanInstData
FROM crs5_oltp.dbo.schdld_pymnt_smmry sps
INNER JOIN (SELECT schdld_pymnt_smmry_id
					, SUM(schdld_pymnt_instnc_unpaid_bal_amnt) AS SUM_OF_OUTSTANDING_INSTALMENTS
				FROM crs5_oltp.dbo.schdld_pymnt_instnc
				WHERE schdld_pymnt_instnc_unpaid_bal_amnt > 0
				GROUP BY schdld_pymnt_smmry_id) oi
ON sps.schdld_pymnt_smmry_id = oi.schdld_pymnt_smmry_id

WHERE sps.schdld_pymnt_smmry_stts_cd = 9 /*ACTIVE*/
AND  oi.SUM_OF_OUTSTANDING_INSTALMENTS IS NOT NULL


SELECT cao.cnsmr_id
	  , SUM(cab.cnsmr_accnt_bal_amnt) AS currentBalance
INTO #CurrentBalance
FROM crs5_oltp.dbo.cnsmr_accnt_ownrs cao
INNER JOIN crs5_oltp.dbo.cnsmr_accnt_bal cab
ON cao.cnsmr_accnt_id = cab.cnsmr_accnt_id
AND cao.cnsmr_accnt_ownrshp_sft_dlt_flg = 'N'
AND cab.bal_nm_id = (SELECT bal_nm_id FROM crs5_oltp.dbo.bal_nm WHERE bal_nm = 'CurrentBalance')
GROUP BY cao.cnsmr_id
HAVING SUM(cab.cnsmr_accnt_bal_amnt) > 0

SELECT ap.cnsmr_id,
	   CASE WHEN (ap.SUM_OF_OUTSTANDING_INSTALMENTS <= (cb.currentBalance -50)) THEN 1 ELSE 0 END AS PlanBalanceRemaining
FROM #ActivePlanInstData ap
INNER JOIN #CurrentBalance cb On ap.cnsmr_id = cb.cnsmr_id
