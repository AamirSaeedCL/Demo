;WITH RankedTags AS
(
    SELECT
        ct.cnsmr_id,
        t.tag_id,
        tt.tag_typ_id,
        tt.tag_typ_shrt_nm,
        ct.cnsmr_tag_assgn_dt,
        ct.cnsmr_tag_sft_delete_flg,
        ct.upsrt_dttm,

        ROW_NUMBER() OVER (
            PARTITION BY ct.cnsmr_id, tt.tag_typ_id
            ORDER BY ct.upsrt_dttm DESC
        ) AS rn
    FROM dbo.cnsmr_tag ct
    JOIN dbo.tag t
        ON t.tag_id = ct.tag_id
    JOIN dbo.tag_typ tt
        ON tt.tag_typ_id = t.tag_typ_id
    WHERE tt.tag_typ_shrt_nm IN ('DIAL_TAG')  
)
SELECT
    tag_typ_id AS typeId,
    COUNT(*) AS TotalRows
FROM RankedTags
WHERE rn = 1      -- âœ… keep only latest tag per customer per tag type
GROUP BY tag_typ_id;
