SELECT 
    p.ConsumerID,
    STRING_AGG(p.PreferenceTypeName, ',') AS ConsumerPreference
FROM (
    SELECT DISTINCT
        ConsumerID,
        CASE 
            WHEN PreferenceTypeCode = '1' THEN 'Email'
            WHEN PreferenceTypeCode = '2' THEN 'SMS'
            WHEN PreferenceTypeCode = '3' THEN 'Phone'
            WHEN PreferenceTypeCode IS NULL OR LTRIM(RTRIM(PreferenceTypeCode)) = '' THEN NULL
        END AS PreferenceTypeName
    FROM [Nyx].[PC].[PCPreference]
    WHERE PreferenceGroupCode = '2'
) AS p 
GROUP BY p.ConsumerID;
