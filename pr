CREATE PROCEDURE [stg].[usp_Customer_Ingestion_UpdateCustomerIsValidMobile]
AS
BEGIN
    SET NOCOUNT ON;
    SET XACT_ABORT ON;  -- Automatically rolls back on runtime errors!

    BEGIN TRY
        BEGIN TRAN;

        -- Update customers' IsValidMobile and ValidPhoneNumber flags where CustomerId matches
        UPDATE c
        SET c.IsValidMobile = cbs.IsValidMobile,
        c.ValidPhoneNumber = cbs.ValidPhoneNumber
        FROM stg.Customer c
        INNER JOIN stg.CustomerMobileStatus cbs ON c.CustomerId = cbs.CustomerId;

        COMMIT TRAN;
    END TRY
    BEGIN CATCH
        -- Rollback if any error occurs and throw an error back to ADF pipeline
        IF XACT_STATE() <> 0
            ROLLBACK TRAN;
        THROW;
    END CATCH
END;
