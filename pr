CREATE PROCEDURE GetLastRunDateTime
    @PipelineId NVARCHAR(50)  -- Input parameter for PipelineId
AS
BEGIN
    -- Declare the default date variable
    DECLARE @DefaultDate DATETIME = '1900-01-01';

    BEGIN TRY
        -- Return the LastRunDateTime using COALESCE for default value handling
        SELECT COALESCE(
            LastRunDateTime, 
            @DefaultDate  -- Use the declared variable for default date
        ) AS LastRunDateTime
        FROM
        (
            -- Subquery to fetch the latest StartDateTime for the given PipelineId
            SELECT TOP 1 
                [StartDateTime] AS LastRunDateTime
            FROM
                [dbo].[DataFactoryPipelineLog]
            WHERE
                PipelineId = @PipelineId  -- Parameterized for dynamic input
                AND ErrorDescription IS NULL
            ORDER BY
                LogId DESC  -- Order by descending to get the most recent log
        ) AS Subquery;

    END TRY
    BEGIN CATCH
        -- Return default date in case of an error
        SELECT @DefaultDate AS LastRunDateTime;  -- Return the default date if an error occurs
    END CATCH;
END;
