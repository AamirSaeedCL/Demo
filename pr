SET NOCOUNT ON;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

CREATE TABLE #TempFirstInstalment (
    schdld_pymnt_smmry_id INT,
    schdld_pymnt_instnc_amnt DECIMAL(18,2),
    schdld_pymnt_instnc_dttm DATETIME2,
    PRIMARY KEY (schdld_pymnt_smmry_id)
);

INSERT INTO #TempFirstInstalment
SELECT
    schdld_pymnt_smmry_id,
    schdld_pymnt_instnc_amnt,
    schdld_pymnt_instnc_dttm
FROM (
    SELECT 
        schdld_pymnt_smmry_id,
        schdld_pymnt_instnc_amnt,
        schdld_pymnt_instnc_dttm,
        ROW_NUMBER() OVER (
            PARTITION BY schdld_pymnt_smmry_id 
            ORDER BY schdld_pymnt_instnc_dttm ASC
        ) AS rn
    FROM [dbo].[schdld_pymnt_instnc] WITH (NOLOCK)
) AS ranked
WHERE rn = 1;

CREATE TABLE #TempPaymentPlan (
    pymnt_frqncy_cd INT,
    pymnt_frqncy_val_txt NVARCHAR(50),
    schdld_pymnt_stts_cd INT,
    schdld_pymnt_stts_val_txt NVARCHAR(50),
    schdld_pymnt_typ_cd INT,
    schdld_pymnt_typ_val_txt NVARCHAR(50)
);

INSERT INTO #TempPaymentPlan
SELECT DISTINCT
    f.pymnt_frqncy_cd,
    f.pymnt_frqncy_val_txt,
    s.schdld_pymnt_stts_cd,
    s.schdld_pymnt_stts_val_txt,
    t.schdld_pymnt_typ_cd,
    t.schdld_pymnt_typ_val_txt
FROM dbo.Ref_pymnt_frqncy_cd f WITH (NOLOCK)
CROSS JOIN dbo.Ref_schdld_pymnt_stts_cd s WITH (NOLOCK)
CROSS JOIN dbo.Ref_schdld_pymnt_typ_cd t WITH (NOLOCK);

--Select from temp table
SELECT DISTINCT
    summary.schdld_pymnt_smmry_id AS PaymentPlanId,
    summary.cnsmr_id AS CustomerId,
    CAST(NULL AS uniqueidentifier) AS CustomerGroupId,
    summary.schdld_pymnt_smmry_ttl_amnt AS PlanAmount,
    summary.schdld_pymnt_smmry_cmmnt_txt AS PlanComment,
    summary.schdld_pymnt_smmry_cnt AS InstalmentCount,
    summary.schdld_pymnt_smmry_dwnpymnt_amnt AS InitialPaymentAmount,
    summary.schdld_pymnt_smmry_dwnpymnt_dttm AS InitialPaymentDate,
    summary.schdld_pymnt_smmry_rglr_amnt AS RegularPaymentAmount,
    fi.schdld_pymnt_instnc_amnt AS FirstInstalmentAmount,
    fi.schdld_pymnt_instnc_dttm AS FirstInstalmentDate,
    summary.schdld_pymnt_smmry_lst_amnt AS LastInstalmentAmount,
    CAST(CASE WHEN settlement.cnsmr_accnt_sttlmnt_id IS NOT NULL THEN 1 ELSE 0 END AS BIT) AS IsSettlement,
    summary.schdld_pymnt_smmry_frqncy_cd AS PlanFrequencyId,
    ref.pymnt_frqncy_val_txt AS PlanFrequencyText,
    summary.schdld_pymnt_smmry_frqncy_cnt AS PlanFrequencyCount,
    summary.schdld_pymnt_smmry_typ_cd AS PlanTypeId,
    ref.schdld_pymnt_typ_val_txt AS PlanTypeText,
    summary.schdld_pymnt_smmry_stts_cd AS PlanStatusId,
    ref.schdld_pymnt_stts_val_txt AS PlanStatusText,
    CAST(CASE WHEN ref.schdld_pymnt_stts_val_txt IS NOT NULL THEN 1 ELSE 0 END AS BIT) AS PlanStatusActive,
    summary.schdld_pymnt_smmry_crt_dttm AS CreatedDate,
    summary.upsrt_dttm AS UpsertDateTime
FROM [dbo].[schdld_pymnt_smmry] summary WITH (NOLOCK)
LEFT JOIN #TempFirstInstalment fi ON fi.schdld_pymnt_smmry_id = summary.schdld_pymnt_smmry_id
LEFT JOIN [dbo].[cnsmr_accnt_sttlmnt] settlement WITH (NOLOCK) 
    ON settlement.schdld_pymnt_smmry_id = summary.schdld_pymnt_smmry_id
JOIN #TempPaymentPlan ref ON 
    ref.pymnt_frqncy_cd = summary.schdld_pymnt_smmry_frqncy_cd
    AND ref.schdld_pymnt_stts_cd = summary.schdld_pymnt_smmry_stts_cd
    AND ref.schdld_pymnt_typ_cd = summary.schdld_pymnt_smmry_typ_cd
OPTION (RECOMPILE);

-- Cleanup
DROP TABLE IF EXISTS #TempFirstInstalment;
DROP TABLE IF EXISTS #TempPaymentPlan;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
