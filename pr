SET NOCOUNT ON;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

-- Attempt to cast the dynamic pipeline parameter to DATETIME2
DECLARE @LastRunDateTime DATETIME2 = TRY_CAST(
    '@{activity('Lookup the pipeline log table to fetch lastrundatetime').output.value[0].LastRunDateTime}' 
    AS DATETIME2
);

-- Validate LastRunDateTime parameter
IF @LastRunDateTime IS NULL
BEGIN
    THROW 50001, 'Invalid LastRunDateTime Value', 1;
END;

-- Use CTE to replace temp table and fetch user account data
WITH UserAccountDataCTE AS (
    SELECT
        ua.UserAccountId AS DigitalId,
        CAST(NULL AS UNIQUEIDENTIFIER) AS CustomerGroupId,
        ua.CustomerPrimaryId AS CustomerId,
        ua.AccountReferenceNumber,
        ua.CreatedAt AS UpsertDateTime,
        u.Activated AS IsActive
    FROM dbo.UserAccount ua WITH (NOLOCK)
    INNER JOIN dbo.[User] u WITH (NOLOCK) 
        ON u.UserId = ua.UserId
    WHERE ua.CreatedAt > @LastRunDateTime
)

-- Final result selection
SELECT 
    DigitalId,
    CustomerGroupId,
    CustomerId,
    AccountReferenceNumber,
    UpsertDateTime,
    IsActive
FROM UserAccountDataCTE
ORDER BY UpsertDateTime;

-- Reset isolation level
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
