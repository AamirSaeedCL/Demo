CREATE PROCEDURE [dbo].[usp_Customer_UpdateCustomerGroupId]
    @FromUpsertDate DATETIME
AS
BEGIN
    SET NOCOUNT ON;
    
    BEGIN TRANSACTION;
    
    -- Update customer group IDs where upsertDate is on or after the specified date
    UPDATE c WITH (TABLOCKX, UPDLOCK, HOLDLOCK)
    SET c.customergroupid = cg.groupId
    FROM dbo.Customer c
    INNER JOIN dbo.ConsumerGroup cg ON c.customerid = cg.consumerid
    WHERE (c.customergroupid <> cg.groupId OR c.customergroupid IS NULL)
      AND c.upsertDate >= @FromUpsertDate;
    
    COMMIT TRANSACTION;
END;


=======================================
CREATE PROCEDURE [dbo].[usp_Customer_UpdateIsActive]
    @FromUpsertDate DATETIME
AS
BEGIN
    SET NOCOUNT ON;

    BEGIN TRANSACTION;

    UPDATE c
    SET c.IsActive = t.NewIsActive
    FROM dbo.Customer c
    INNER JOIN (
        SELECT 
            c.CustomerId,
            MAX(CASE 
                    WHEN wg.WorkGroupShortName NOT IN ('ZZZ', 'SDR')
                     AND REPLACE(tag.TagShortName, 'S-', '') NOT IN ('80', '81', '61', '96')
                     AND accBal.CurrentBalance > 0 
                    THEN 1 
                    ELSE 0 
                END) AS NewIsActive
        FROM dbo.Customer c
        LEFT JOIN dbo.WorkGroup wg ON c.customerid = wg.customerid
        LEFT JOIN dbo.CustomerTag tag ON c.customerid = tag.customerid
        LEFT JOIN dbo.Account acc ON c.customerid = acc.customerid 
        LEFT JOIN dbo.AccountBalance accBal ON acc.accountid = accBal.accountid 
        WHERE (c.IsActive IS NULL 
               OR c.IsActive <> 
                    CASE 
                        WHEN wg.WorkGroupShortName NOT IN ('ZZZ', 'SDR')
                         AND REPLACE(tag.TagShortName, 'S-', '') NOT IN ('80', '81', '61', '96')
                         AND accBal.CurrentBalance > 0 
                        THEN 1 
                        ELSE 0 
                    END)
          AND c.upsertDate >= @FromUpsertDate
        GROUP BY c.CustomerId
    ) t ON c.CustomerId = t.CustomerId;

    COMMIT TRANSACTION;
END;
