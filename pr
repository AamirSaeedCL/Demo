LastDates AS (
    SELECT aa.*,
           CASE 
               WHEN CAST(
                    (SELECT MAX(val) FROM (VALUES 
                        (ActivePlanDate_P1),(ActivePlanDate_S1),(ActivePlanDate_S2),(ActivePlanDate_S3),(ActivePlanDate_S4)
                    ) AS t(val))
                    AS DATE
               ) <= CAST(
                    (SELECT MAX(val) FROM (VALUES 
                        (LastJAOPAY_P1),(LastJAOPAY_S1),(LastJAOPAY_S2),(LastJAOPAY_S3),(LastJAOPAY_S4)
                    ) AS t(val))
                    AS DATE
               )
               THEN 1 ELSE 0 
           END AS JAOPAYAfterPlan
    FROM AllAccounts AS aa
)
