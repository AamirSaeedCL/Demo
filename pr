    td.cnsmr_id						 AS CustomerId,
    td.cnsmr_idntfr_lgcy_txt		 AS LegacyId,
	MAX(td.upsrt_dttm)				 AS UpsertDateTime,
    -- DD Tag
    MAX(CASE WHEN tag_typ_shrt_nm = 'DDRETCD' THEN tag_typ_shrt_nm END)			AS DDTag,
    MAX(CASE WHEN tag_typ_shrt_nm = 'DDRETCD' THEN cnsmr_tag_assgn_dt END)		AS DateDDAssigned,
    MAX(CASE WHEN tag_typ_shrt_nm = 'DDRETCD' THEN tag_removed_dt END)			AS DateDDRemoved,
    CAST(MAX(CASE WHEN tag_typ_shrt_nm = 'DDRETCD' THEN tag_active END) AS bit) AS DDActive,

    -- Dial Tag
    MAX(CASE WHEN tag_typ_shrt_nm = 'DIAL_TAG' THEN tag_typ_shrt_nm END)		AS DialTag,
    MAX(CASE WHEN tag_typ_shrt_nm = 'DIAL_TAG' THEN cnsmr_tag_assgn_dt END)		AS DateDialAssigned,
    MAX(CASE WHEN tag_typ_shrt_nm = 'DIAL_TAG' THEN tag_removed_dt END)			AS DateDialRemoved,
    CAST(MAX(CASE WHEN tag_typ_shrt_nm = 'DIAL_TAG' THEN tag_active END) AS bit)  AS DialActive,

    -- Digital Tag
    MAX(CASE WHEN tag_typ_shrt_nm = 'DIGITAL' THEN tag_typ_shrt_nm END)     AS DigitalTag,
    MAX(CASE WHEN tag_typ_shrt_nm = 'DIGITAL' THEN cnsmr_tag_assgn_dt END)  AS DateDigitalAssigned,
    MAX(CASE WHEN tag_typ_shrt_nm = 'DIGITAL' THEN tag_removed_dt END)      AS DateDigitalRemoved,
    CAST(MAX(CASE WHEN tag_typ_shrt_nm = 'DIGITAL' THEN tag_active END) AS bit)  AS DigitalActive,

    -- Payer Phase Tag
    MAX(CASE WHEN tag_typ_shrt_nm = 'PAYPHASE' THEN tag_typ_shrt_nm END)    AS PayerPhaseTag,
    MAX(CASE WHEN tag_typ_shrt_nm = 'PAYPHASE' THEN cnsmr_tag_assgn_dt END) AS DatePayerPhaseAssigned,
    MAX(CASE WHEN tag_typ_shrt_nm = 'PAYPHASE' THEN tag_removed_dt END)     AS DatePayerPhaseRemoved,
    CAST(MAX(CASE WHEN tag_typ_shrt_nm = 'PAYPHASE' THEN tag_active END) AS bit)  AS PayerPhaseActive,

    -- Phase Tag
    MAX(CASE WHEN tag_typ_shrt_nm = 'PHASE' THEN tag_typ_shrt_nm END)       AS PhaseTag,
    MAX(CASE WHEN tag_typ_shrt_nm = 'PHASE' THEN cnsmr_tag_assgn_dt END)    AS DatePhaseAssigned,
    MAX(CASE WHEN tag_typ_shrt_nm = 'PHASE' THEN tag_removed_dt END)        AS DatePhaseRemoved,
    CAST(MAX(CASE WHEN tag_typ_shrt_nm = 'PHASE' THEN tag_active END) AS bit)  AS PhaseActive,

    -- Plan Tag
    MAX(CASE WHEN tag_typ_shrt_nm = 'PLANSTAT' THEN tag_typ_shrt_nm END)    AS PlanTag,
    MAX(CASE WHEN tag_typ_shrt_nm = 'PLANSTAT' THEN cnsmr_tag_assgn_dt END) AS DatePlanAssigned,
    MAX(CASE WHEN tag_typ_shrt_nm = 'PLANSTAT' THEN tag_removed_dt END)     AS DatePlanRemoved,
    CAST(MAX(CASE WHEN tag_typ_shrt_nm = 'PLANSTAT' THEN tag_active END) AS bit) AS PlanActive,

    -- PreDef Tag
    MAX(CASE WHEN tag_typ_shrt_nm = 'PREDEF' THEN tag_typ_shrt_nm END)      AS PreDefTag,
    MAX(CASE WHEN tag_typ_shrt_nm = 'PREDEF' THEN cnsmr_tag_assgn_dt END)   AS DatePreDefAssigned,
    MAX(CASE WHEN tag_typ_shrt_nm = 'PREDEF' THEN tag_removed_dt END)       AS DatePreDefRemoved,
    CAST(MAX(CASE WHEN tag_typ_shrt_nm = 'PREDEF' THEN tag_active END) AS bit) AS PreDefActive,

    -- Remediation Tag
    MAX(CASE WHEN tag_typ_shrt_nm = 'RMDTN' THEN tag_typ_shrt_nm END)       AS RemediationTag,
    MAX(CASE WHEN tag_typ_shrt_nm = 'RMDTN' THEN cnsmr_tag_assgn_dt END)    AS DateRemediationAssigned,
    MAX(CASE WHEN tag_typ_shrt_nm = 'RMDTN' THEN tag_removed_dt END)        AS DateRemediationRemoved,
    CAST(MAX(CASE WHEN tag_typ_shrt_nm = 'RMDTN' THEN tag_active END) AS bit)  AS RemediationActive,

    -- SMS Tag
    MAX(CASE WHEN tag_typ_shrt_nm = 'SMS' THEN tag_typ_shrt_nm END)         AS SMSTag,
    MAX(CASE WHEN tag_typ_shrt_nm = 'SMS' THEN cnsmr_tag_assgn_dt END)      AS DateSMSAssigned,
    MAX(CASE WHEN tag_typ_shrt_nm = 'SMS' THEN tag_removed_dt END)          AS DateSMSRemoved,
    CAST(MAX(CASE WHEN tag_typ_shrt_nm = 'SMS' THEN tag_active END) AS bit) AS SMSActive,

    -- Current Status Tag (PlatStat)
    MAX(CASE WHEN tag_typ_shrt_nm = 'PLATSTAT' THEN tag_typ_shrt_nm END)    AS StatusTag,
    MAX(CASE WHEN tag_typ_shrt_nm = 'PLATSTAT' THEN cnsmr_tag_assgn_dt END) AS DateStatusAssigned,
    MAX(CASE WHEN tag_typ_shrt_nm = 'PLATSTAT' THEN tag_removed_dt END)     AS DateStatusRemoved,
    CAST(MAX(CASE WHEN tag_typ_shrt_nm = 'PLATSTAT' THEN tag_active END) AS bit) AS StatusActive,

    -- Previous Status Tag (latest deleted PlatStat)
    MAX(CASE 
            WHEN tag_typ_shrt_nm = 'PLATSTAT' 
                 AND td.cnsmr_tag_sft_delete_flg = 'Y'
                 AND td.tag_removed_dt = ps.latest_removed_dt
            THEN tag_typ_shrt_nm
        END) AS PreviousStatusTag,
    MAX(CASE 
            WHEN tag_typ_shrt_nm = 'PLATSTAT'
                 AND td.cnsmr_tag_sft_delete_flg = 'Y'
                 AND td.tag_removed_dt = ps.latest_removed_dt
            THEN cnsmr_tag_assgn_dt
        END) AS DatePreviousStatusAssigned,
    MAX(CASE 
            WHEN tag_typ_shrt_nm = 'PLATSTAT'
                 AND td.cnsmr_tag_sft_delete_flg = 'Y'
                 AND td.tag_removed_dt = ps.latest_removed_dt
            THEN tag_removed_dt
        END) AS DatePreviousStatusRemoved,
    CAST(MAX(CASE 
            WHEN tag_typ_shrt_nm = 'PLATSTAT'
                 AND td.cnsmr_tag_sft_delete_flg = 'Y'
                 AND td.tag_removed_dt = ps.latest_removed_dt
            THEN 0
        END) AS bit) AS PreviousStatusActive
