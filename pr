CREATE OR ALTER PROCEDURE [dbo].[usp_LoadCustomerTagFromStaging]
AS
BEGIN
    SET NOCOUNT ON;
    SET XACT_ABORT ON;

    BEGIN TRY
        BEGIN TRANSACTION;

        MERGE dbo.CustomerTag AS tgt
        USING (
            SELECT 
                CustomerId,
                LegacyId,
                CustomerGroupId,

                DDTag, DateDDAssigned, DateDDRemoved, DDActive,
                DialTag, DateDialAssigned, DateDialRemoved, DialActive,
                DigitalTag, DateDigitalAssigned, DateDigitalRemoved, DigitalActive,
                PayerPhaseTag, DatePayerPhaseAssigned, DatePayerPhaseRemoved, PayerPhaseActive,
                PhaseTag, DatePhaseAssigned, DatePhaseRemoved, PhaseActive,
                PlanTag, DatePlanAssigned, DatePlanRemoved, PlanActive,
                PreDefTag, DatePreDefAssigned, DatePreDefRemoved, PreDefActive,
                RemediationTag, DateRemediationAssigned, DateRemediationRemoved, RemediationActive,
                SMSTag, DateSMSAssigned, DateSMSRemoved, SMSActive,
                StatusTag, DateStatusAssigned, DateStatusRemoved, StatusActive,
                PreviousStatusTag, DatePreviousStatusAssigned, DatePreviousStatusRemoved, PreviousStatusActive
            FROM stg.CustomerTag
        ) AS src
        ON  tgt.CustomerId = src.CustomerId
        AND tgt.LegacyId   = src.LegacyId

        WHEN MATCHED THEN
            UPDATE SET
                tgt.CustomerGroupId             = src.CustomerGroupId,

                tgt.DDTag                       = src.DDTag,
                tgt.DateDDAssigned              = src.DateDDAssigned,
                tgt.DateDDRemoved               = src.DateDDRemoved,
                tgt.DDActive                    = ISNULL(src.DDActive, tgt.DDActive),

                tgt.DialTag                     = src.DialTag,
                tgt.DateDialAssigned            = src.DateDialAssigned,
                tgt.DateDialRemoved             = src.DateDialRemoved,
                tgt.DialActive                  = ISNULL(src.DialActive, tgt.DialActive),

                tgt.DigitalTag                  = src.DigitalTag,
                tgt.DateDigitalAssigned         = src.DateDigitalAssigned,
                tgt.DateDigitalRemoved          = src.DateDigitalRemoved,
                tgt.DigitalActive               = ISNULL(src.DigitalActive, tgt.DigitalActive),

                tgt.PayerPhaseTag               = src.PayerPhaseTag,
                tgt.DatePayerPhaseAssigned      = src.DatePayerPhaseAssigned,
                tgt.DatePayerPhaseRemoved       = src.DatePayerPhaseRemoved,
                tgt.PayerPhaseActive            = ISNULL(src.PayerPhaseActive, tgt.PayerPhaseActive),

                tgt.PhaseTag                    = src.PhaseTag,
                tgt.DatePhaseAssigned           = src.DatePhaseAssigned,
                tgt.DatePhaseRemoved            = src.DatePhaseRemoved,
                tgt.PhaseActive                 = ISNULL(src.PhaseActive, tgt.PhaseActive),

                tgt.PlanTag                     = src.PlanTag,
                tgt.DatePlanAssigned            = src.DatePlanAssigned,
                tgt.DatePlanRemoved             = src.DatePlanRemoved,
                tgt.PlanActive                  = ISNULL(src.PlanActive, tgt.PlanActive),

                tgt.PreDefTag                   = src.PreDefTag,
                tgt.DatePreDefAssigned          = src.DatePreDefAssigned,
                tgt.DatePreDefRemoved           = src.DatePreDefRemoved,
                tgt.PreDefActive                = ISNULL(src.PreDefActive, tgt.PreDefActive),

                tgt.RemediationTag              = src.RemediationTag,
                tgt.DateRemediationAssigned     = src.DateRemediationAssigned,
                tgt.DateRemediationRemoved      = src.DateRemediationRemoved,
                tgt.RemediationActive           = ISNULL(src.RemediationActive, tgt.RemediationActive),

                tgt.SMSTag                      = src.SMSTag,
                tgt.DateSMSAssigned             = src.DateSMSAssigned,
                tgt.DateSMSRemoved              = src.DateSMSRemoved,
                tgt.SMSActive                   = ISNULL(src.SMSActive, tgt.SMSActive),

                tgt.StatusTag                   = src.StatusTag,
                tgt.DateStatusAssigned          = src.DateStatusAssigned,
                tgt.DateStatusRemoved           = src.DateStatusRemoved,
                tgt.StatusActive                = ISNULL(src.StatusActive, tgt.StatusActive),

                tgt.PreviousStatusTag           = src.PreviousStatusTag,
                tgt.DatePreviousStatusAssigned  = src.DatePreviousStatusAssigned,
                tgt.DatePreviousStatusRemoved   = src.DatePreviousStatusRemoved,
                tgt.PreviousStatusActive        = ISNULL(src.PreviousStatusActive, tgt.PreviousStatusActive)

        WHEN NOT MATCHED BY TARGET THEN
            INSERT (
                CustomerId,
                LegacyId,
                CustomerGroupId,

                DDTag, DateDDAssigned, DateDDRemoved, DDActive,
                DialTag, DateDialAssigned, DateDialRemoved, DialActive,
                DigitalTag, DateDigitalAssigned, DateDigitalRemoved, DigitalActive,
                PayerPhaseTag, DatePayerPhaseAssigned, DatePayerPhaseRemoved, PayerPhaseActive,
                PhaseTag, DatePhaseAssigned, DatePhaseRemoved, PhaseActive,
                PlanTag, DatePlanAssigned, DatePlanRemoved, PlanActive,
                PreDefTag, DatePreDefAssigned, DatePreDefRemoved, PreDefActive,
                RemediationTag, DateRemediationAssigned, DateRemediationRemoved, RemediationActive,
                SMSTag, DateSMSAssigned, DateSMSRemoved, SMSActive,
                StatusTag, DateStatusAssigned, DateStatusRemoved, StatusActive,
                PreviousStatusTag, DatePreviousStatusAssigned, DatePreviousStatusRemoved, PreviousStatusActive
            )
            VALUES (
                src.CustomerId,
                src.LegacyId,
                src.CustomerGroupId,

                src.DDTag, src.DateDDAssigned, src.DateDDRemoved, ISNULL(src.DDActive, 0),
                src.DialTag, src.DateDialAssigned, src.DateDialRemoved, ISNULL(src.DialActive, 0),
                src.DigitalTag, src.DateDigitalAssigned, src.DateDigitalRemoved, ISNULL(src.DigitalActive, 0),
                src.PayerPhaseTag, src.DatePayerPhaseAssigned, src.DatePayerPhaseRemoved, ISNULL(src.PayerPhaseActive, 0),
                src.PhaseTag, src.DatePhaseAssigned, src.DatePhaseRemoved, ISNULL(src.PhaseActive, 0),
                src.PlanTag, src.DatePlanAssigned, src.DatePlanRemoved, ISNULL(src.PlanActive, 0),
                src.PreDefTag, src.DatePreDefAssigned, src.DatePreDefRemoved, ISNULL(src.PreDefActive, 0),
                src.RemediationTag, src.DateRemediationAssigned, src.DateRemediationRemoved, ISNULL(src.RemediationActive, 0),
                src.SMSTag, src.DateSMSAssigned, src.DateSMSRemoved, ISNULL(src.SMSActive, 0),
                src.StatusTag, src.DateStatusAssigned, src.DateStatusRemoved, ISNULL(src.StatusActive, 0),
                src.PreviousStatusTag, src.DatePreviousStatusAssigned, src.DatePreviousStatusRemoved, ISNULL(src.PreviousStatusActive, 0)
            );

        COMMIT TRANSACTION;
    END TRY
    BEGIN CATCH
        IF XACT_STATE() <> 0
            ROLLBACK TRANSACTION;

        THROW;
    END CATCH
END
GO
